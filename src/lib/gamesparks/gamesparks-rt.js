OpCodes={};OpCodes.LOGIN_RESULT=-1;OpCodes.PING_RESULT=-3;OpCodes.UDP_CONNECT_MESSAGE=-5;OpCodes.PLAYER_READY_MESSAGE=-7;OpCodes.PLAYER_CONNECT_MESSAGE=-101;OpCodes.PLAYER_DISCONNECT_MESSAGE=-103;var Connection=function(session){this.session=session;this.stopped=false};Connection.prototype={stop:function(){this.stopped=true;this.stopInternal()},onPacketReceived:function(p,packetSize){if(p.command){if(p.command["abstractResultType"]){var result=p.command;result.configure(p,this.session);if(result.executeAsync()){this.session.submitAction(p.command)}else{p.command.execute()}}else{this.session.submitAction(p.command)}}else{if(!p.hasPayload){var cmd;if(p.sender){cmd=CustomCommand.pool.pop().configure(p.opCode,p.sender,null,p.data,0,this.session,packetSize)}else{cmd=CustomCommand.pool.pop().configure(p.opCode,0,null,p.data,0,this.session,packetSize)}if(cmd){this.session.submitAction(cmd)}}}}};var ReliableConnection=function(remotehost,remoteport,session){Connection.call(this,session);this.remotehost=remotehost;this.remoteport=remoteport};ReliableConnection.prototype=Object.create(Connection.prototype);ReliableConnection.prototype.connect=function(){this.client=new WebSocket("wss://"+this.remotehost+":"+this.remoteport);this.client.binaryType="arraybuffer";this.client.onopen=this.onopen.bind(this);this.client.onclose=this.onclose.bind(this);this.client.onerror=this.onerror.bind(this);this.client.onmessage=this.onmessage.bind(this)};ReliableConnection.prototype.onopen=function(e){if(this.stopped||this.session==null){if(this.client!=null){this.client.close();this.client=null}return}this.session.log("ReliableConnection",GameSparksRT.logLevel.DEBUG," TCP Connection Established");var loginCmd=new LoginCommand(this.session.connectToken);this.send(loginCmd)};ReliableConnection.prototype.onmessage=function(e){if(this.stopped){if(this.client!=null){this.client.close();this.client=null}return}var data=e.data;var read=data.byteLength;var rss=new Stream;var array=Array.from(new Uint8Array(data));rss.writeBytes(array,0,read);rss.setPosition(0);while(rss.getPosition()<read){var p=PooledObjects.packetPool.pop();var bytesRead=this.read(rss,p);this.onPacketReceived(p,bytesRead);PooledObjects.packetPool.push(p);p=PooledObjects.packetPool.pop()}};ReliableConnection.prototype.onclose=function(e){if(this.session!=null){this.session.log("ReliableConnection",GameSparksRT.logLevel.DEBUG," TCP Connection Closed")}if(!this.stopped&&this.client!=null){}else{}};ReliableConnection.prototype.onerror=function(e){if(this.session!=null){this.session.log("ReliableConnection",GameSparksRT.logLevel.DEBUG," TCP Connection Error")}console.log(e)};ReliableConnection.prototype.send=function(request){if(this.client!=null&&this.client.readyState==WebSocket.OPEN){var stream=new Stream;var p=request.toPacket(this.session,false);var ret=Packet.serializeLengthDelimited(stream,p);var buffer=new Uint8Array(stream.getBuffer());this.client.send(buffer);PooledObjects.packetPool.push(p);return ret}else{return-1}};ReliableConnection.prototype.read=function(stream,p){if(this.stopped){return 0}p.session=this.session;p.reliable=true;var ret=Packet.deserializeLengthDelimited(stream,p);if(p.reliable==null){p.reliable=true}return ret};ReliableConnection.prototype.stopInternal=function(){if(this.client!=null&&this.client.readyState==WebSocket.OPEN){this.client.close();this.client=null}};Wire={};Wire.VARINT=0;Wire.FIXED64=1;Wire.LENGTH_DELIMITED=2;Wire.FIXED32=5;var Key=function(field,wireType){this.field=field;this.wireType=wireType};Key.prototype={toString:function(){return"[Key: "+this.field+", "+this.wireType+"]"}};function assert(condition,message){if(!condition){message=message||"Assertion failed";if(typeof Error!=="undefined"){throw new Error(message)}throw message}}var Stream=function(){this.buffer="";this.position=0};Stream.prototype={getPosition:function(){return this.position},setPosition:function(position){this.position=position},getLength:function(){return this.buffer.length},bytesAvailable:function(){return this.buffer.length-this.position},readByte:function(){var ret=this.readChar();if(typeof ret==="number"&&ret==-1){return 0}else{return ret.charCodeAt(0)}},readChar:function(){var buffer="";var totalBytes;var ret;ret=this.readChars(buffer,this.position,1);totalBytes=ret[0];buffer=ret[1];if(totalBytes==1){return buffer.slice(0,1)}else{return-1}},readChars:function(buffer,position,length){assert(typeof buffer==="string","buffer must be string");if(this.bytesAvailable()<=0){console.log("WARNING: Reached end of the stream");return[0,buffer]}if(length<=0){console.log("WARNING: no characters read (length = 0)");return[0,buffer]}if(buffer.length>0){assert(position>=0&&position<buffer.length,"position out of range")}else{position=0}var subString;var newBuffer="";var startPosition=this.position;var endPosition=startPosition+length;var newLength;if(endPosition>this.buffer.length){endPosition=this.buffer.length}newLength=endPosition-startPosition;subString=this.buffer.slice(startPosition,endPosition);this.position=endPosition;if(position==0){newBuffer=subString;if(subString.length<buffer.length){newBuffer=newBuffer+buffer.slice(newLength)}}else{newBuffer=buffer.slice(0,position)+subString;if(position+newLength+1<=buffer.length){newBuffer=newBuffer+buffer.slice(position+newLength)}}return[newLength,newBuffer]},read:function(buffer,position,length){assert(typeof buffer==="object"&&Array.isArray(buffer),"buffer must be array");var ret;var totalBytes;var newBuffer="";var newArray=[];for(var i=0;i<buffer.length;i++){newBuffer=newBuffer+String.fromCharCode(buffer[i])}ret=this.readChars(newBuffer,position,length);totalBytes=ret[0];newBuffer=ret[1];for(var i=0;i<newBuffer.length;i++){newArray.push(newBuffer.charCodeAt(i))}return[totalBytes,newArray]},writeByte:function(byte){assert(typeof byte==="number","not valid byte");assert(byte>=0&&byte<=255,"not valid byte");this.writeChar(String.fromCharCode(byte))},writeChar:function(char){this.writeChars(char,0,1)},writeChars:function(buffer,position,length){assert(typeof buffer==="string","buffer must be string");assert(buffer&&buffer.length>0,"buffer must not be nil or empty");if(this.bytesAvailable()<0){console.log("WARNING: Reached end of the stream");return}if(length<=0){console.log("WARNING: no characters written (length = 0)");return[0,buffer]}assert(position>=0&&position<buffer.length,"position out of range");var subString;var newBuffer="";var startPosition=position;var endPosition=startPosition+length;var newLength;if(endPosition>buffer.length){endPosition=buffer.length}newLength=endPosition-startPosition;subString=buffer.slice(startPosition,endPosition);if(this.position==0){newBuffer=subString;if(this.buffer.length>subString.length){newBuffer=newBuffer+this.buffer.slice(newLength)}}else{newBuffer=this.buffer.slice(0,this.position)+subString;if(this.position+newLength+1<=this.buffer.length){newBuffer=newBuffer+this.buffer.slice(this.position+newLength)}}this.buffer=newBuffer;this.position=this.position+newLength},writeBytes:function(buffer,position,length){assert(typeof buffer==="object"&&Array.isArray(buffer),"buffer must be array");var newBuffer="";for(var i=position;i<position+length;i++){if(i>=buffer.length){break}newBuffer=newBuffer+String.fromCharCode(buffer[i])}this.writeChars(newBuffer,0,length)},seek:function(offset){this.position=this.position-offset;if(this.position<0){this.position=0}else if(this.position>=this.buffer.length){this.position=this.buffer.length-1}},toHex:function(){var ret="";for(var i=0;i<Math.ceil(this.buffer.length/16)*16;i++){if(i%16==0){var value=i.toString(16);for(var a=value.length;a<8;a++){ret=ret+"0"}ret=ret+value+"  "}if(i>=this.buffer.length){ret=ret+"## "}else{var value=this.buffer.charCodeAt(i).toString(16);for(var a=value.length;a<2;a++){ret=ret+"0"}ret=ret+value+" "}if((i+1)%8==0){ret=ret+" "}if((i+1)%16==0){var value=this.buffer.slice(i-16+1,i+1);ret=ret+value.replace("[^ -~]",".")+"\n"}}return ret},toString:function(){return this.buffer},getBuffer:function(){var buffer=[];for(var i=0;i<this.buffer.length;i++){buffer.push(this.buffer.charCodeAt(i))}return buffer}};var PositionStream=function(){this.tempBuffer=[];this.bytesRead=0;this.stream=null};PositionStream.prototype={wrap:function(baseStream){this.bytesRead=0;this.stream=baseStream},read:function(buffer,offset,count){var ret=this.stream.read(buffer,offset,count);this.bytesRead=this.bytesRead+ret[0];return ret},readByte:function(){var ret=this.read(this.tempBuffer,0,1);if(ret[0]==1){this.tempBuffer=ret[1];return this.tempBuffer[0]}return-1},seek:function(offset){for(var i=0;i<offset;i++){this.readByte()}return this.bytesRead},getLength:function(){return this.stream.getLength()},getPosition:function(){return this.bytesRead}};var LimitedPositionStream=function(){PositionStream.call(this);this.limit=0};LimitedPositionStream.prototype=Object.create(PositionStream.prototype);LimitedPositionStream.prototype.wrap=function(baseStream,limit){PositionStream.prototype.wrap.call(this,baseStream);this.limit=limit};LimitedPositionStream.prototype.read=function(buffer,offset,count){var toRead;if(count>this.limit-this.bytesRead){toRead=this.limit-this.bytesRead}else{toRead=count}return PositionStream.prototype.read.call(this,buffer,offset,toRead)};LimitedPositionStream.prototype.readByte=function(){if(this.bytesRead>=this.limit){return-1}else{return PositionStream.prototype.readByte.call(this)}};LimitedPositionStream.prototype.skipToEnd=function(){if(this.bytesRead<this.limit){var discardBytes=PooledObjects.byteBufferPool.pop();while(this.read(discardBytes,this.bytesRead,256)[0]==256){}PooledObjects.byteBufferPool.push(discardBytes)}};ProtocolParser={};ProtocolParser.readBool=function(stream){var b=stream.readByte();if(b<0){console.log("WARNING: Stream ended too early");return false}else if(b==1){return true}else if(b==0){return false}print("WARNING: Invalid boolean value");return false};ProtocolParser.readUInt32=function(stream){var b;var val=0;for(var n=0;n<=4;n++){b=stream.readByte();if(b<0){console.log("WARNING: Stream ended too early");return 0}if(n==4&&(b&240)!=0){console.log("WARNING: Got larger VarInt than 32bit unsigned");return 0}if((b&128)==0){return val|b<<7*n}val=val|(b&127)<<7*n}console.log("WARNING: Got larger VarInt than 32bit unsigned");return 0};ProtocolParser.readZInt32=function(stream){var val=ProtocolParser.readUInt32(stream);return val>>1^val<<31>>31};ProtocolParser.readSingle=function(stream){var bytes=[];var val=0;for(var n=1;n<=4;n++){bytes[4-n]=stream.readByte()}val=bytes[0]<<24|bytes[1]<<16|(bytes[2]<<8|bytes[3]);var negative=(bytes[0]&128)==128;var exponent=(val&2139095040)>>23;var sign;var mantissa=0;if(negative){sign=-1}else{sign=1}if(exponent==255){if(negative){value=Number.NEGATIVE_INFINITY}else{value=Number.POSITIVE_INFINITY}}else if(exponent==0){value=0}else{exponent=exponent-127+1;for(var i=3;i>=2;i--){mantissa+=bytes[i];mantissa/=256}mantissa+=bytes[1]&127;mantissa=(mantissa/128+1)/2;var value=sign*Math.pow(2,exponent)*mantissa}return value};ProtocolParser.readUInt64=function(stream){var b;var val=0;for(var n=0;n<=9;n++){b=stream.readByte();if(b<0){console.log("WARNING: Stream ended too early");return 0}if(n==9&&(b&254)!=0){console.log("WARNING: Got larger VarInt than 64 bit unsigned");return 0}if((b&128)==0){return val+b*Math.pow(128,n)}val=val+(b&127)*Math.pow(128,n)}console.log("WARNING: Got larger VarInt than 64 bit unsigned");return 0};ProtocolParser.readZInt64=function(stream){var val=ProtocolParser.readUInt64(stream);var sign=false;if(val%2==1){sign=true}val=Math.floor(val/2);if(sign==true){return-val}else{return val}};ProtocolParser.readDouble=function(stream){var bytes=[];var valh=0;for(var n=1;n<=8;n++){bytes[8-n]=stream.readByte()}valh=bytes[0]<<24|bytes[1]<<16;var negative=(bytes[0]&128)==128;var exponent=(valh&2146435072)>>20;var mantissa=0;var sign;if(negative){sign=-1}else{sign=1}if(exponent==2047){if(negative){value=Number.NEGATIVE_INFINITY}else{value=Number.POSITIVE_INFINITY}}else if(exponent==0){value=0}else{exponent=exponent-1023+1;for(var i=7;i>=2;i--){mantissa+=bytes[i];mantissa/=256}mantissa+=bytes[1]&15;mantissa=(mantissa/16+1)/2;var value=sign*Math.pow(2,exponent)*mantissa}return value};ProtocolParser.readString=function(stream){var length=ProtocolParser.readUInt32(stream);var ms=PooledObjects.memoryStreamPool.pop();var buffer=PooledObjects.byteBufferPool.pop();var read=0;var ret;var r;while(read<length){ret=stream.read(buffer,0,Math.min(length-read,buffer.length));r=ret[0];buffer=ret[1];if(r==0){console.log("WARNING: Expected "+(length-read).toString()+" got "+read);return 0}ms.writeBytes(buffer,0,r);read=read+r}ret=ms.toString().slice(0,ms.getPosition());PooledObjects.byteBufferPool.push(buffer);PooledObjects.memoryStreamPool.push(ms);return ret};ProtocolParser.readKey=function(firstByte,stream){if(firstByte<128){return new Key(firstByte>>3,firstByte&7)}var fieldID=ProtocolParser.readUInt32(stream)<<4|firstByte>>3&15;return new Key(fieldID,firstByte&7)};ProtocolParser.skipKey=function(stream,key){if(key.wireType==Wire.FIXED32){stream.seek(4)}else if(key.wireType==Wire.FIXED64){stream.seek(8)}else if(key.wireType==Wire.LENGTH_DELIMITED){stream.seek(ProtocolParser.readUInt32(stream))}else if(key.wireType==Wire.VARINT){ProtocolParser.readSkipVarInt(stream)}else{console.log("WARNING: Unknown wire type: "+key.wireType)}};ProtocolParser.readSkipVarInt=function(stream){while(true){var b=stream.readByte();if(b<0){console.log("WARNING: Stream ended too early");return}if((b&128)==0){return}}};ProtocolParser.writeBool=function(stream,val){if(val){return stream.writeByte(1)}else{return stream.writeByte(0)}};ProtocolParser.writeUInt32=function(stream,val){var b;val=Math.abs(val);while(true){b=val&127;val=val>>>7;if(val==0){stream.writeByte(b);break}else{b=b|128;stream.writeByte(b)}}};ProtocolParser.writeZInt32=function(stream,val){var val1=val<<1;var val2=val>>31;ProtocolParser.writeUInt32(stream,val1^val2)};ProtocolParser.writeUInt64=function(stream,val){var b;val=Math.abs(val);while(true){b=val&127;val=Math.floor(val/128);if(val==0){stream.writeByte(b);break}else{b=b|128;stream.writeByte(b)}}};ProtocolParser.writeZInt64=function(stream,val){var sign=false;if(val<0){val=-val;sign=true}val=val*2;if(sign==true){val=val+1}ProtocolParser.writeUInt64(stream,val)};ProtocolParser.frexp=function(arg){arg=Number(arg);const result=[arg,0];if(arg!==0&&Number.isFinite(arg)){const absArg=Math.abs(arg);const log2=Math.log2||function log2(n){return Math.log(n)*Math.LOG2E};let exp=Math.max(-1023,Math.floor(log2(absArg))+1);let x=absArg*Math.pow(2,-exp);while(x<.5){x*=2;exp--}while(x>=1){x*=.5;exp++}if(arg<0){x=-x}result[0]=x;result[1]=exp}return result};ProtocolParser.writeSingle=function(stream,val){var bytes=[0,0,0,0];if(val!=0){var anum=Math.abs(val);var ret=ProtocolParser.frexp(anum);var mantissa=ret[0];var exponent=ret[1];var sign=val!=anum&&128||0;mantissa=mantissa*2-1;if(mantissa==Infinity){mantissa=0;exponent=255}else{exponent=exponent-1;exponent=exponent+127;if(exponent<0||exponent>=255){mantissa=0;if(exponent<0){exponent=0}else{exponent=255}}}bytes[0]=sign+(exponent>>1);mantissa*=128;var currentmantissa=Math.floor(mantissa);mantissa-=currentmantissa;bytes[1]=((exponent&1)<<7)+currentmantissa;for(var i=2;i<4;i++){mantissa*=256;currentmantissa=Math.floor(mantissa);mantissa-=currentmantissa;bytes[i]=currentmantissa}}for(var i=bytes.length-1;i>=0;i--){stream.writeByte(bytes[i])}};ProtocolParser.writeDouble=function(stream,val){var bytes=[0,0,0,0,0,0,0,0];if(val!=0){var anum=Math.abs(val);var ret=ProtocolParser.frexp(anum);var mantissa=ret[0];var exponent=ret[1];var sign=val!=anum&&128||0;mantissa=mantissa*2-1;if(mantissa==Infinity){mantissa=0;exponent=2047}else{exponent=exponent-1;exponent=exponent+1023;if(exponent<0||exponent>=2047){mantissa=0;if(exponent<0){exponent=0}else{exponent=2047}}}bytes[0]=sign+(exponent>>4);mantissa*=16;var currentmantissa=Math.floor(mantissa);mantissa-=currentmantissa;bytes[1]=((exponent&15)<<4)+currentmantissa;for(var i=2;i<8;i++){mantissa*=256;currentmantissa=Math.floor(mantissa);mantissa-=currentmantissa;bytes[i]=currentmantissa}}for(var i=bytes.length-1;i>=0;i--){stream.writeByte(bytes[i])}};ProtocolParser.writeBytes=function(stream,val,len){ProtocolParser.writeUInt32(stream,len);stream.writeBytes(val,0,len)};ProtocolParser.writeString=function(stream,val){var array=[];for(var i=0;i<val.length;i++){array.push(val.charCodeAt(i))}ProtocolParser.writeBytes(stream,array,val.length)};var ObjectPool=function(creator,refresher,maxSize){this.stack=[];this.creator=creator;this.refresher=refresher;this.maxSize=maxSize};ObjectPool.prototype={pop:function(){if(this.stack.length==0){return this.creator()}else{return this.stack.shift()}},push:function(item){if(item){if(this.stack.indexOf(item)>=0){return}if(this.stack.length<this.maxSize){if(this.refresher){this.refresher(item)}this.stack.push(item)}}},dispose:function(){this.stack=[]}};var LogCommand=function(){this.tag=null;this.msg=null;this.level=null;this.session=null};LogCommand.pool=new ObjectPool(function(){return new LogCommand},null,5);LogCommand.prototype={configure:function(session,tag,level,msg){this.tag=tag;this.msg=msg;this.level=level;this.session=session;return this},execute:function(){if(GameSparksRT.shouldLog(this.tag,this.level)){if(this.session.peerId){GameSparksRT.logger(this.session.peerId+" "+this.tag+":"+this.msg)}else{GameSparksRT.logger(" "+this.tag+":"+this.msg)}}LogCommand.pool.push(this)}};var CustomCommand=function(){this.session=null;this.opCode=0;this.sender=0;this.limit=0;this.packetSize=0;this.ms=null;this.limitedStream=null;this.data=null};CustomCommand.pool=new ObjectPool(function(){return new CustomCommand},null,5);CustomCommand.prototype={configure:function(opCode,sender,lps,data,limit,session,packetSize){this.ms=PooledObjects.memoryStreamPool.pop();this.packetSize=packetSize;this.opCode=opCode;this.sender=sender;this.data=data;this.session=session;this.limit=limit;this.limitedStream=null;if(lps!=null){this.limitedStream=PooledObjects.limitedPositionStreamPool.pop();for(var i=1;i<=limit;i++){var read=lps.readByte();this.ms.writeByte(read)}this.ms.setPosition(0);this.limitedStream.wrap(this.ms,limit)}return this},execute:function(){this.session.onPacket(new RTPacket(this.opCode,this.sender,this.limitedStream,this.limit,this.data,this.packetSize));PooledObjects.memoryStreamPool.push(this.ms);PooledObjects.limitedPositionStreamPool.push(this.limitedStream);CustomCommand.pool.push(this)}};var ActionCommand=function(){this.action=null};ActionCommand.pool=new ObjectPool(function(){return new ActionCommand},null,5);ActionCommand.prototype={configure:function(action){this.action=action;return this},execute:function(){this.action();ActionCommand.pool.push(this)}};CommandFactory={};CommandFactory.getCommand=function(opCode,sender,sequence,stream,session,data,packetSize){var ret=null;var limit=ProtocolParser.readUInt32(stream);var lps=PooledObjects.limitedPositionStreamPool.pop();lps.wrap(stream,limit);if(opCode==OpCodes.LOGIN_RESULT){ret=LoginResult.deserialize(lps,LoginResult.pool.pop())}else if(opCode==OpCodes.PING_RESULT){ret=PingResult.deserialize(lps,PingResult.pool.pop())}else if(opCode==OpCodes.UDP_CONNECT_MESSAGE){ret=UDPConnectMessage.deserialize(lps,UDPConnectMessage.pool.pop())}else if(opCode==OpCodes.PLAYER_CONNECT_MESSAGE){ret=PlayerConnectMessage.deserialize(lps,PlayerConnectMessage.pool.pop())}else if(opCode==OpCodes.PLAYER_DISCONNECT_MESSAGE){ret=PlayerDisconnectMessage.deserialize(lps,PlayerDisconnectMessage.pool.pop())}else{if(session.shouldExecute(sender,sequence)){ret=CustomCommand.pool.pop().configure(opCode,sender,lps,data,limit,session,packetSize)}}lps.skipToEnd();PooledObjects.limitedPositionStreamPool.push(lps);return ret};var AbstractResult=function(){this.abstractResultType=true;this.packet=null;this.session=null};AbstractResult.prototype={configure:function(packet,session){this.packet=packet;this.session=session},executeAsync:function(){return true}};var LoginResult=function(){AbstractResult.call(this);this.success=false;this.reconnectToken=null;this.peerId=null;this.activePeers=[];this.fastPort=null};LoginResult.pool=new ObjectPool(function(){return new LoginResult},function(instance){instance.activePeers=[];instance.fastPort=null;instance.reconnectToken=null;instance.peerId=null},5);LoginResult.prototype=Object.create(AbstractResult.prototype);LoginResult.prototype.execute=function(){this.session.connectToken=this.reconnectToken;this.session.peerId=this.peerId;if(this.packet.reliable==null||this.packet.reliable==true){if(this.fastPort!=null&&this.fastPort){this.session.fastPort=this.fastPort}this.session.activePeers=this.activePeers.slice();this.session.setConnectState(GameSparksRT.connectState.RELIABLE_ONLY);this.session.connectFast();this.session.log("LoginResult",GameSparksRT.logLevel.DEBUG,this.session.peerId+" TCP LoginResult, ActivePeers "+this.session.activePeers.length)}else{this.session.setConnectState(GameSparksRT.connectState.RELIABLE_AND_FAST_SEND)}LoginResult.pool.push(this)};LoginResult.prototype.executeAsync=function(){return false};LoginResult.deserialize=function(stream,instance){if(instance.activePeers==null){instance.activePeers=[]}while(true){var keyByte=stream.readByte();if(keyByte==-1){break}var _continue=false;if(keyByte==8){instance.success=ProtocolParser.readBool(stream);_continue=true}else if(keyByte==18){instance.reconnectToken=ProtocolParser.readString(stream);_continue=true}else if(keyByte==24){instance.peerId=ProtocolParser.readUInt64(stream);_continue=true}else if(keyByte==32){instance.activePeers.push(ProtocolParser.readUInt64(stream));_continue=true}else if(keyByte==40){instance.fastPort=ProtocolParser.readUInt64(stream);_continue=true}if(!_continue){var key=ProtocolParser.readKey(keyByte,stream);if(key.field==0){console.log("WARNING: Invalid field id: 0, something went wrong in the stream");return null}else{ProtocolParser.skipKey(stream,key)}}}return instance};var PingResult=function(){AbstractResult.call(this)};PingResult.pool=new ObjectPool(function(){return new PingResult},null,5);PingResult.prototype=Object.create(AbstractResult.prototype);PingResult.prototype.execute=function(){this.session.log("PingResult",GameSparksRT.LogLevel.DEBUG,"");PingResult.pool.push(this)};PingResult.prototype.executeAsync=function(){return false};PingResult.deserialize=function(stream,instance){while(true){var keyByte=stream.readByte();if(keyByte==-1){break}var key=ProtocolParser.readKey(keyByte,stream);if(key.field==0){console.log("WARNING: Invalid field id: 0, something went wrong in the stream");return null}else{ProtocolParser.skipKey(stream,key)}}return instance};var PlayerConnectMessage=function(){AbstractResult.call(this);this.peerId=0;this.activePeers=[]};PlayerConnectMessage.pool=new ObjectPool(function(){return new PlayerConnectMessage},function(instance){instance.activePeers=[]},5);PlayerConnectMessage.prototype=Object.create(AbstractResult.prototype);PlayerConnectMessage.prototype.execute=function(){this.session.activePeers=[];this.session.activePeers=this.activePeers.slice();this.session.log("PlayerConnectMessage",GameSparksRT.logLevel.DEBUG,"PeerId="+this.peerId+", ActivePeers "+this.session.activePeers.length);this.session.onPlayerConnect(this.peerId);PlayerConnectMessage.pool.push(this)};PlayerConnectMessage.deserialize=function(stream,instance){if(instance.activePeers==null){instance.activePeers=[]}while(true){var keyByte=stream.readByte();if(keyByte==-1){break}var _continue=false;if(keyByte==8){instance.peerId=ProtocolParser.readUInt64(stream);_continue=true}else if(keyByte==32){instance.activePeers.push(ProtocolParser.readUInt64(stream));_continue=true}if(!_continue){var key=ProtocolParser.readKey(keyByte,stream);if(key.field==0){console.log("WARNING: Invalid field id: 0, something went wrong in the stream");return null}else{ProtocolParser.skipKey(stream,key)}}}return instance};var PlayerDisconnectMessage=function(){AbstractResult.call(this);this.peerId=0;this.activePeers=[]};PlayerDisconnectMessage.pool=new ObjectPool(function(){return new PlayerDisconnectMessage},function(instance){instance.activePeers=[]},5);PlayerDisconnectMessage.prototype=Object.create(AbstractResult.prototype);PlayerDisconnectMessage.prototype.execute=function(){this.session.activePeers=[];this.session.activePeers=this.activePeers.slice();this.session.log("PlayerDisconnectMessage",GameSparksRT.logLevel.DEBUG,"PeerId="+this.peerId+", ActivePeers "+this.session.activePeers.length);this.session.onPlayerDisconnect(this.peerId);PlayerDisconnectMessage.pool.push(this)};PlayerDisconnectMessage.deserialize=function(stream,instance){if(instance.activePeers==null){instance.activePeers=[]}while(true){var keyByte=stream.readByte();if(keyByte==-1){break}var _continue=false;if(keyByte==8){instance.peerId=ProtocolParser.readUInt64(stream);_continue=true}else if(keyByte==32){instance.activePeers.push(ProtocolParser.readUInt64(stream));_continue=true}if(!_continue){var key=ProtocolParser.readKey(keyByte,stream);if(key.field==0){console.log("WARNING: Invalid field id: 0, something went wrong in the stream");return null}else{ProtocolParser.skipKey(stream,key)}}}return instance};var UDPConnectMessage=function(){AbstractResult.call(this)};UDPConnectMessage.pool=new ObjectPool(function(){return new UDPConnectMessage},null,5);UDPConnectMessage.prototype=Object.create(AbstractResult.prototype);UDPConnectMessage.prototype.execute=function(){var reliable;if(this.packet.reliable!=null){reliable=this.packet.reliable}else{reliable=false}this.session.log("UDPConnectMessage",GameSparksRT.logLevel.DEBUG,"(UDP) reliable="+reliable.toString()+", ActivePeers "+this.session.activePeers.length);if(!reliable){self.session.setConnectState(GameSparksRT.connectState.RELIABLE_AND_FAST);self.session.sendData(-5,GameSparksRT.deliveryIntent.RELIABLE,null,null)}else{self.session.log("UDPConnectMessage",GameSparksRT.logLevel.DEBUG,"TCP (Unexpected) UDPConnectMessage")}UDPConnectMessage.pool.push(this)};UDPConnectMessage.prototype.executeAsync=function(){return false};UDPConnectMessage.deserialize=function(stream,instance){while(true){var keyByte=stream.readByte();if(keyByte==-1){break}var key=ProtocolParser.readKey(keyByte,stream);if(key.field==0){console.log("WARNING: Invalid field id: 0, something went wrong in the stream");return null}else{ProtocolParser.skipKey(stream,key)}}return instance};var RTRequest=function(){this.data=null;this.opCode=0;this.targetPlayers=[];this.intent=GameSparksRT.deliveryIntent.RELIABLE};RTRequest.prototype={toPacket:function(session,fast){return null},reset:function(){this.targetPlayers=[]},serialize:function(stream){}};var LoginCommand=function(token){RTRequest.call(this);this.opCode=0;this.token=token;this.clientVersion=2};LoginCommand.prototype=Object.create(RTRequest.prototype);LoginCommand.prototype.toPacket=function(session,fast){var p=PooledObjects.packetPool.pop();p.opCode=this.opCode;p.data=this.data;p.session=session;if(!fast&&this.intent!=GameSparksRT.deliveryIntent.RELIABLE){p.reliable=false}if(this.intent==GameSparksRT.deliveryIntent.UNRELIABLE_SEQUENCED){p.sequenceNumber=session.nextSequenceNumber()}if(this.targetPlayers.length>0){p.targetPlayers=this.targetPlayers}p.request=this;return p};LoginCommand.prototype.serialize=function(stream){if(this.token!=null){stream.writeByte(10);ProtocolParser.writeString(stream,this.token)}if(this.clientVersion!=null){stream.writeByte(16);ProtocolParser.writeUInt64(stream,this.clientVersion)}};var PingCommand=function(token){RTRequest.call(this);this.opCode=-2};PingCommand.prototype=Object.create(RTRequest.prototype);PingCommand.prototype.toPacket=function(session,fast){var p=PooledObjects.packetPool.pop();p.opCode=this.opCode;p.data=this.data;p.session=session;if(!fast&&this.intent!=GameSparksRT.deliveryIntent.RELIABLE){p.reliable=false}if(this.intent==GameSparksRT.deliveryIntent.UNRELIABLE_SEQUENCED){p.sequenceNumber=session.nextSequenceNumber()}if(this.targetPlayers.length>0){p.targetPlayers=this.targetPlayers}p.request=this;return p};PingCommand.prototype.serialize=function(stream){};var CustomRequest=function(){RTRequest.call(this);this.payload=null};CustomRequest.prototype=Object.create(RTRequest.prototype);CustomRequest.prototype.configure=function(opCode,intent,payload,data,targetPlayers){this.opCode=opCode;this.payload=payload;this.intent=intent;this.data=data;if(targetPlayers!=null){for(var i in targetPlayers){this.targetPlayers.push(targetPlayers[i])}}};CustomRequest.prototype.toPacket=function(session,fast){var p=PooledObjects.packetPool.pop();p.opCode=this.opCode;p.data=this.data;p.session=session;if(!fast&&this.intent!=GameSparksRT.deliveryIntent.RELIABLE){p.reliable=false}if(this.intent==GameSparksRT.deliveryIntent.UNRELIABLE_SEQUENCED){p.sequenceNumber=session.nextSequenceNumber()}if(this.targetPlayers.length>0){p.targetPlayers=this.targetPlayers}p.request=this;return p};CustomRequest.prototype.serialize=function(stream){if(this.payload){stream.writeBytes(this.payload,0,this.payload.length)}};CustomRequest.prototype.reset=function(){this.payload=null;RTRequest.prototype.reset.call(this)};var Packet=function(){this.opCode=0;this.sequenceNumber=null;this.requestId=null;this.targetPlayers=null;this.sender=null;this.reliable=null;this.data=null;this.payload=null;this.request=null;this.hasPayload=false;this.command=null;this.session=null};Packet.prototype={reset:function(){this.opCode=0;this.sequenceNumber=null;this.requestId=null;this.targetPlayers=null;this.sender=null;this.reliable=null;this.payload=null;this.command=null;this.request=null;this.hasPayload=false;this.data=null},toString:function(){return"{OpCode:"+this.opCode+",TargetPlayers:"+this.targetToString()+"}"},targetToString:function(){var s="[";if(this.targetPlayers!=null){for(var i=0;i<this.targetPlayers.length;i++){s=s+this.targetPlayers[i]+" "}}return s+"]"},readPayload:function(stream,packetSize){this.hasPayload=true;if(this.sender!=null){this.command=CommandFactory.getCommand(this.opCode,this.sender,this.sequenceNumber,stream,this.session,this.data,packetSize)}else{this.command=CommandFactory.getCommand(this.opCode,0,this.sequenceNumber,stream,this.session,this.data,packetSize)}return null},writePayload:function(stream){if(this.request!=null){var ms=PooledObjects.memoryStreamPool.pop();this.request.serialize(ms);var written=ms.getBuffer();if(ms.getPosition()>0){stream.writeByte(122);ProtocolParser.writeBytes(stream,written,ms.getPosition())}PooledObjects.memoryStreamPool.push(ms)}else if(this.payload!=null){stream.writeByte(122);ProtocolParser.writeBytes(stream,this.payload,this.payload.length)}}};Packet.serialize=function(stream,instance){stream.writeByte(8);ProtocolParser.writeZInt32(stream,instance.opCode);if(instance.sequenceNumber!=null){stream.writeByte(16);ProtocolParser.writeUInt64(stream,instance.sequenceNumber)}if(instance.requestId!=null){stream.writeByte(24);ProtocolParser.writeUInt64(stream,instance.requestId)}if(instance.targetPlayers!=null){for(var i=0;i<instance.targetPlayers.length;i++){stream.writeByte(32);ProtocolParser.writeUInt64(stream,instance.targetPlayers[i])}}if(instance.sender!=null){stream.writeByte(40);ProtocolParser.writeUInt64(stream,instance.sender)}if(instance.reliable!=null){stream.writeByte(48);ProtocolParser.writeBool(stream,instance.reliable)}if(instance.data!=null){stream.writeByte(114);RTData.writeRTData(stream,instance.data)}instance.writePayload(stream);return stream};Packet.serializeLengthDelimited=function(stream,instance){var ms=PooledObjects.memoryStreamPool.pop();var ret;Packet.serialize(ms,instance);var data=ms.getBuffer();ProtocolParser.writeBytes(stream,data,ms.getPosition());ret=ms.getPosition();PooledObjects.memoryStreamPool.push(ms);return ret};Packet.deserializeLengthDelimited=function(stream,instance){var limit=ProtocolParser.readUInt32(stream);var origLimit=limit;limit=limit+stream.getPosition();while(true){if(stream.getPosition()>=limit){if(stream.getPosition()==limit){break}else{console.log("WARNING: Read past max limit");return 0}}var keyByte=stream.readByte();if(keyByte==-1){console.log("WARNING: End of stream");return 0}var _continue=false;if(keyByte==8){instance.opCode=ProtocolParser.readZInt32(stream);_continue=true}else if(keyByte==16){instance.sequenceNumber=ProtocolParser.readUInt64(stream);_continue=true}else if(keyByte==24){instance.requestId=ProtocolParser.readUInt64(stream);_continue=true}else if(keyByte==40){instance.sender=ProtocolParser.readUInt64(stream);_continue=true}else if(keyByte==48){instance.reliable=ProtocolParser.readBool(stream);_continue=true}else if(keyByte==114){if(instance.data==null){instance.data=RTData.readRTData(stream,instance.data)}else{RTData.readRTData(stream,instance.data)}_continue=true}else if(keyByte==122){instance.payload=instance.readPayload(stream,origLimit);_continue=true}if(!_continue){var key=ProtocolParser.readKey(keyByte,stream);if(key.field==0){console.log("WARNING: Invalid field id: 0, something went wrong in the stream");return 0}else{ProtocolParser.skipKey(stream,key)}}}return origLimit};PooledObjects={};PooledObjects.packetPool=new ObjectPool(function(){return new Packet},function(packet){packet.reset()},5);PooledObjects.memoryStreamPool=new ObjectPool(function(){return new Stream},function(stream){stream.setPosition(0)},5);PooledObjects.positionStreamPool={};PooledObjects.limitedPositionStreamPool=new ObjectPool(function(){return new LimitedPositionStream},null,5);PooledObjects.byteBufferPool=new ObjectPool(function(){var array=[];for(var i=0;i<256;i++){array.push(0)}return array},null,5);PooledObjects.customRequestPool=new ObjectPool(function(){return new CustomRequest},function(cr){cr.reset()},5);RTDataSerializer={};RTDataSerializer.cache=new ObjectPool(function(){return new RTData},function(rtData){for(var i=0;i<rtData.data.length;i++){if(rtData.data[i].data_val){rtData.data[i].data_val.dispose()}rtData.data[i].reset()}},5);RTDataSerializer.get=function(){return RTDataSerializer.cache.pop()};RTDataSerializer.readRTData=function(stream,instance){if(instance==null){instance=RTDataSerializer.cache.pop()}var limit=ProtocolParser.readUInt32(stream);limit=limit+stream.getPosition();while(true){if(stream.getPosition()>=limit){if(stream.getPosition()==limit){break}else{console.log("WARNING: Read past max limit");return null}}var keyByte=stream.readByte();if(keyByte==-1){break}var key=ProtocolParser.readKey(keyByte,stream);if(key.wireType==Wire.VARINT){instance.data[key.field]=RTVal.newLong(ProtocolParser.readZInt64(stream))}else if(key.wireType==Wire.FIXED32){instance.data[key.field]=RTVal.newFloat(ProtocolParser.readSingle(stream))}else if(key.wireType==Wire.FIXED64){instance.data[key.field]=RTVal.newDouble(ProtocolParser.readDouble(stream))}else if(key.wireType==Wire.LENGTH_DELIMITED){instance.data[key.field]=RTVal.deserializeLengthDelimited(stream)}if(key.field==0){console.log("WARNING: Invalid field id: 0, something went wrong in the stream");return null}}return instance};RTDataSerializer.writeRTData=function(stream,instance){var ms=PooledObjects.memoryStreamPool.pop();for(var index=1;index<instance.data.length;index++){var entry=instance.data[index];if(entry.long_val!=null){ProtocolParser.writeUInt32(ms,index<<3);ProtocolParser.writeZInt64(ms,entry.long_val)}else if(entry.float_val!=null){ProtocolParser.writeUInt32(ms,index<<3|5);ProtocolParser.writeSingle(ms,entry.float_val)}else if(entry.double_val!=null){ProtocolParser.writeUInt32(ms,index<<3|1);ProtocolParser.writeDouble(ms,entry.double_val)}else if(entry.data_val||entry.string_val||entry.vec_val){ProtocolParser.writeUInt32(ms,index<<3|2);entry.serializeLengthDelimited(ms)}}var buffer=ms.getBuffer();ProtocolParser.writeBytes(stream,buffer,ms.getPosition());PooledObjects.memoryStreamPool.push(ms)};var RTVector=function(x,y,z,w){this.x=x;this.y=y;this.z=z;this.w=w};RTVector.prototype={};var RTVal=function(){this.long_val=null;this.float_val=null;this.double_val=null;this.data_val=null;this.string_val=null;this.vec_val=null};RTVal.prototype={serializeLengthDelimited:function(stream){var ms=PooledObjects.memoryStreamPool.pop();if(this.string_val){ms.writeByte(10);ProtocolParser.writeString(ms,this.string_val)}else if(this.data_val){ms.writeByte(114);RTData.writeRTData(ms,this.data_val)}else if(this.vec_val){var vec_value=this.vec_val;var numberOfFloatsSet=0;ms.writeByte(18);if(vec_value.x!=null){numberOfFloatsSet=numberOfFloatsSet+1}if(vec_value.y!=null){numberOfFloatsSet=numberOfFloatsSet+1}if(vec_value.z!=null){numberOfFloatsSet=numberOfFloatsSet+1}if(vec_value.w!=null){numberOfFloatsSet=numberOfFloatsSet+1}ProtocolParser.writeUInt32(ms,4*numberOfFloatsSet);for(var i=1;i<=numberOfFloatsSet;i++){if(i==1){ProtocolParser.writeSingle(ms,vec_value.x)}else if(i==2){ProtocolParser.writeSingle(ms,vec_value.y)}else if(i==3){ProtocolParser.writeSingle(ms,vec_value.z)}else if(i==4){ProtocolParser.writeSingle(ms,vec_value.w)}}}var data=ms.getBuffer();ProtocolParser.writeBytes(stream,data,ms.getPosition());PooledObjects.memoryStreamPool.push(ms)},reset:function(){if(this.data_val){this.data_val.dispose()}this.long_val=null;this.float_val=null;this.double_val=null;this.data_val=null;this.string_val=null;this.vec_val=null},dirty:function(){if(this.long_val!=null){return true}else if(this.float_val!=null){return true}else if(this.double_val!=null){return true}else if(this.data_val){return true}else if(this.string_val){return true}else if(this.vec_val){return true}return false},asString:function(){if(this.long_val!=null){return this.long_val.toString()}else if(this.float_val!=null){return this.float_val.toString()}else if(this.double_val!=null){return this.double_val.toString()}else if(this.data_val){return this.data_val.toString()}else if(this.string_val){return'"'+this.string_val+'"'}else if(this.vec_val){var ret="|";if(this.vec_val.x!=null){ret=ret+this.vec_val.x.toString()+"|"}if(this.vec_val.y!=null){ret=ret+this.vec_val.y.toString()+"|"}if(this.vec_val.z!=null){ret=ret+this.vec_val.z.toString()+"|"}if(this.vec_val.w!=null){ret=ret+this.vec_val.w.toString()+"|"}return ret}return null}};RTVal.newLong=function(value){var instance=new RTVal;instance.long_val=value;return instance};RTVal.newFloat=function(value){var instance=new RTVal;instance.float_val=value;return instance};RTVal.newDouble=function(value){var instance=new RTVal;instance.double_val=value;return instance};RTVal.newRTData=function(value){var instance=new RTVal;instance.data_val=value;return instance};RTVal.newString=function(value){var instance=new RTVal;instance.string_val=value;return instance};RTVal.newRTVector=function(value){var instance=new RTVal;instance.vec_val=value;return instance};RTVal.deserializeLengthDelimited=function(stream){var instance=new RTVal;var limit=ProtocolParser.readUInt32(stream);limit=limit+stream.getPosition();while(true){if(stream.getPosition()>=limit){if(stream.getPosition()==limit){break}else{console.log("WARNING: Read past max limit");return 0}}var keyByte=stream.readByte();if(keyByte==-1){console.log("WARNING: End of stream");return 0}var _continue=false;if(keyByte==10){instance.string_val=ProtocolParser.readString(stream);_continue=true}else if(keyByte==18){var end2=ProtocolParser.readUInt32(stream);end2=end2+stream.getPosition();var v=new RTVector;var i=0;while(stream.getPosition()<end2){var read=ProtocolParser.readSingle(stream);if(i==0){v.x=read}else if(i==1){v.y=read}else if(i==2){v.z=read}else if(i==3){v.w=read}i=i+1}instance.vec_val=v;if(stream.getPosition()!=end2){console.log("WARNING: Read too many bytes in packed data");return null}_continue=true}else if(keyByte==114){if(instance.data_val==null){instance.data_val=RTDataSerializer.cache.pop()}RTData.readRTData(stream,instance.data_val);_continue=true}if(!_continue){var key=ProtocolParser.readKey(keyByte,stream);if(key.field==0){console.log("WARNING: Invalid field id: 0, something went wrong in the stream");return null}else{ProtocolParser.skipKey(stream,key)}}}return instance};var RTData=function(){this.data=[];for(var i=0;i<GameSparksRT.MAX_RTDATA_SLOTS;i++){this.data.push(new RTVal)}};RTData.get=function(){return RTDataSerializer.cache.pop()};RTData.readRTData=function(stream,instance){return RTDataSerializer.readRTData(stream,instance)};RTData.writeRTData=function(stream,instance){RTDataSerializer.writeRTData(stream,instance)};RTData.prototype={dispose:function(){for(var i=0;i<this.data.length;i++){if(this.data[i].dirty()){this.data[i]=new RTVal}}RTDataSerializer.cache.push(this)},getRTVector:function(index){return this.data[index].vec_val},getLong:function(index){return this.data[index].long_val},getFloat:function(index){return this.data[index].float_val},getDouble:function(index){return this.data[index].double_val},getString:function(index){return this.data[index].string_val},getData:function(index){return this.data[index].data_val},setRTVector:function(index,value){this.data[index]=RTVal.newRTVector(value);return this},setLong:function(index,value){if(isFinite(value)){this.data[index]=RTVal.newLong(value)}else{console.error("Not a valid number error")}return this},setFloat:function(index,value){if(isFinite(value)){this.data[index]=RTVal.newFloat(value)}else{console.error("Not a valid number error")}return this},setDouble:function(index,value){if(isFinite(value)){this.data[index]=RTVal.newDouble(value)}else{console.error("Not a valid number error")}return this},setString:function(index,value){this.data[index]=RTVal.newString(value);return this},setData:function(index,value){this.data[index]=RTVal.newRTData(value);return this},toString:function(){return this.asString()},asString:function(){var builder=" {";for(var i=0;i<GameSparksRT.MAX_RTDATA_SLOTS;i++){var val=this.data[i].asString();if(val!=null){builder=builder+" ["+i.toString()+" "+val+"] "}}builder=builder+"} ";return builder}};var RTPacket=function(opCode,sender,limitedStream,limit,data,packetSize){this.opCode=opCode;this.sender=sender;this.stream=limitedStream;this.streamLength=limit;this.data=data;this.packetSize=packetSize};RTPacket.prototype={toString:function(){var string="OpCode="+this.opCode+",Sender="+this.sender+",streamExists=";if(this.stream!=null){string=string+"true,StreamLength="+this.streamLength}else{string=string+"false"}string=string+",Data=";if(this.data!=null){string=string+this.data.toString()}else{string=string+".PacketSize="+this.packetSize}return string}};var RTSessionImpl=function(connectToken,hostName,tcpPort,listener){this.connectToken=connectToken;this.tcpPort=tcpPort;this.fastPort=tcpPort;this.hostName=hostName;this.activePeers=[];this.running=false;this.ready=false;this.actionQueue=[];this.connectState=GameSparksRT.connectState.DISCONNECTED;this.mustConnnectBy=(new Date).getTime();this.reliableConnection=null;this.sequenceNumber=0;this.peerId=null;this.peerMaxSequenceNumbers=[];this.listener=listener};RTSessionImpl.prototype={start:function(){this.running=true},stop:function(){this.log("IRTSession",GameSparksRT.logLevel.DEBUG,"Stopped");this.running=false;this.ready=false;if(this.reliableConnection){this.reliableConnection.stop()}this.setConnectState(GameSparksRT.connectState.DISCONNECTED)},update:function(){if(this.running){this.checkConnection()}var toExecute=null;while(true){toExecute=this.getNextAction();if(toExecute){toExecute.execute()}else{break}}},getNextAction:function(){if(this.actionQueue.length>0){return this.actionQueue.shift()}return null},submitAction:function(action){this.actionQueue.push(action)},checkConnection:function(){if(this.connectState==GameSparksRT.connectState.DISCONNECTED){this.log("IRTSession",GameSparksRT.logLevel.INFO,"Disconnected, trying to connect");this.setConnectState(GameSparksRT.connectState.CONNECTING);this.connectReliable()}else if(this.connectState==GameSparksRT.connectState.CONNECTING&&(new Date).getTime()>this.mustConnnectBy){this.setConnectState(GameSparksRT.connectState.DISCONNECTED);this.log("IRTSession",GameSparksRT.logLevel.INFO,"Not connected in time, retrying");if(this.reliableConnection){this.reliableConnection.stopInternal();this.reliableConnection=null}}},setConnectState:function(value){if(value==GameSparksRT.connectState.RELIABLE_AND_FAST_SEND||value==GameSparksRT.connectState.RELIABLE_AND_FAST){value=GameSparksRT.connectState.RELIABLE_ONLY}if(value!=this.connectState){if(this.connectState<value||value==GameSparksRT.connectState.DISCONNECTED){this.log("IRTSession",GameSparksRT.logLevel.DEBUG,"State Change : from "+this.connectState+" to "+value+", ActivePeers "+this.activePeers.length);this.connectState=value}if(value==GameSparksRT.connectState.RELIABLE_ONLY){this.onReady(true)}}},connectFast:function(){},connectReliable:function(){this.mustConnnectBy=(new Date).getTime()+GameSparksRT.TCP_CONNECT_TIMEOUT_SECONDS*1e3;this.reliableConnection=new ReliableConnection(this.hostName,this.tcpPort,this);this.reliableConnection.connect()},nextSequenceNumber:function(){var sequenceNumber=this.sequenceNumber;this.sequenceNumber=this.sequenceNumber+1;return sequenceNumber},shouldExecute:function(peerId,sequence){if(sequence==null){return true}else if(this.peerMaxSequenceNumbers[peerId]==null){this.peerMaxSequenceNumbers[peerId]=0}if(this.peerMaxSequenceNumbers[peerId]>sequence){this.log("IRTSession",GameSparksRT.logLevel.DEBUG,"Discarding sequence id "+sequence+" from peer "+peerId.toString());return false}else{this.peerMaxSequenceNumbers[peerId]=sequence;return true}},resetSequenceForPeer:function(peerId){if(this.peerMaxSequenceNumbers[peerId]){this.peerMaxSequenceNumbers[peerId]=0}},onPlayerConnect:function(peerId){this.resetSequenceForPeer(peerId);if(this.listener){if(this.ready){this.listener.onPlayerConnect(peerId)}}},onPlayerDisconnect:function(peerId){if(this.listener){if(this.ready){this.listener.onPlayerDisconnect(peerId)}}},onReady:function(ready){if(!this.ready&&ready){this.sendData(OpCodes.PLAYER_READY_MESSAGE,GameSparksRT.deliveryIntent.RELIABLE,null,null);if(this.peerId){var ok=false;for(var k in this.activePeers){if(this.activePeers[k]==this.peerId){ok=true;break}}if(!ok){this.activePeers.push(this.peerId)}}}this.ready=ready;if(!this.ready){this.setConnectState(GameSparksRT.connectState.DISCONNECTED)}if(this.listener){var myListener=this.listener;this.submitAction(ActionCommand.pool.pop().configure(function(){myListener.onReady(ready)}))}},onPacket:function(packet){if(this.listener){this.listener.onPacket(packet)}else{throw new Error("AccessViolationException")}},sendData:function(opCode,intent,payload,data,targetPlayers){return this.sendRTDataAndBytes(opCode,intent,payload,data,targetPlayers)},sendRTData:function(opCode,intent,data,targetPlayers){return this.sendRTDataAndBytes(opCode,intent,null,data,targetPlayers)},sendBytes:function(opCode,intent,payload,targetPlayers){return this.sendRTDataAndBytes(opCode,intent,payload,null,targetPlayers)},sendRTDataAndBytes:function(opCode,intent,payload,data,targetPlayers){var csr=PooledObjects.customRequestPool.pop();var ret;csr.configure(opCode,intent,payload,data,targetPlayers);if(this.connectState>=GameSparksRT.connectState.RELIABLE_ONLY){ret=this.reliableConnection.send(csr);PooledObjects.customRequestPool.push(csr);return ret}PooledObjects.customRequestPool.push(csr);return 0},log:function(tag,level,msg){if(GameSparksRT.shouldLog(tag,level)){this.submitAction(LogCommand.pool.pop().configure(this,tag,level,msg))}}};(function(root,factory){if(typeof define==="function"&&define.amd){define(["crypto-js","ws"],factory)}else if(typeof module==="object"&&module.exports){module.exports=factory(require("crypto-js"),require("ws"))}else{root.GameSparksRT=factory(root.CryptoJS,root.WebSocket||root.MozWebSocket)}})(this,function(CryptoJS,WebSocket){var GameSparksRT=function(){};GameSparksRT.MAX_RTDATA_SLOTS=128;GameSparksRT.TCP_CONNECT_TIMEOUT_SECONDS=5;GameSparksRT.logLevel={};GameSparksRT.logLevel.DEBUG=0;GameSparksRT.logLevel.INFO=1;GameSparksRT.logLevel.WARN=2;GameSparksRT.logLevel.ERROR=3;GameSparksRT.connectState={};GameSparksRT.connectState.DISCONNECTED=0;GameSparksRT.connectState.CONNECTING=1;GameSparksRT.connectState.RELIABLE_ONLY=2;GameSparksRT.connectState.RELIABLE_AND_FAST_SEND=3;GameSparksRT.connectState.RELIABLE_AND_FAST=4;GameSparksRT.deliveryIntent={};GameSparksRT.deliveryIntent.RELIABLE=0;GameSparksRT.deliveryIntent.UNRELIABLE=1;GameSparksRT.deliveryIntent.UNRELIABLE_SEQUENCED=2;GameSparksRT.currLogLevel=GameSparksRT.logLevel.INFO;GameSparksRT.tagLevels={};GameSparksRT.logger=function(msg){console.log(msg)};GameSparksRT.getSession=function(connectToken,hostName,tcpPort,listener){return new RTSessionImpl(connectToken,hostName,tcpPort,listener)};GameSparksRT.setRootLogLevel=function(level){GameSparksRT.currLogLevel=level};GameSparksRT.setLogLevel=function(tag,level){GameSparksRT.tagLevels[tag]=level};GameSparksRT.shouldLog=function(tag,level){for(var key in GameSparksRT.tagLevels){var value=GameSparksRT.tagLevels[key];if(key==tag){return value>=level}}return GameSparksRT.currLogLevel<=level};GameSparksRT.prototype={};return GameSparksRT});